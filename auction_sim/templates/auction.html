{% extends "base.html" %}

{% block title %}{{ auction_type.capitalize() }} Auction Simulation{% endblock %}

{% block content %}
<div class="container mt-5">
    <!-- Page Title -->
    <h1 class="text-center">{{ auction_type.capitalize() }} Auction Simulation</h1>

    <!-- Form to Set Auction Parameters -->
    <h2 class="mt-4">Set Auction Parameters</h2>
    <form id="simulation-form">
        <!-- Number of Bidders Input -->
        <div class="row mb-3">
            <label for="num_bidders" class="col-sm-2 col-form-label">Number of Bidders:</label>
            <div class="col-sm-10">
                <input type="number" id="num_bidders" name="num_bidders" class="form-control" required>
            </div>
        </div>

        {% if auction_type == 'english' %}
            <!-- Duration Input for English Auction -->
            <div class="row mb-3">
                <label for="duration" class="col-sm-2 col-form-label">Duration (in rounds):</label>
                <div class="col-sm-10">
                    <input type="number" id="duration" name="duration" class="form-control" required>
                </div>
            </div>

            <!-- Reserve Price Input for English Auction -->
            <div class="row mb-3">
                <label for="reserve_price" class="col-sm-2 col-form-label">Reserve Price:</label>
                <div class="col-sm-10">
                    <input type="number" id="reserve_price" name="reserve_price" class="form-control">
                </div>
            </div>

            <!-- Bidding Styles for Each Bidder -->
            <h3>Bidding Styles</h3>
            <p>Set bidding style for each bidder (aggressive, conservative, random):</p>
            <div id="bidding-styles" class="mb-3"></div>

            <!-- Simulate Auction Button for English Auction -->
            <button type="button" class="btn btn-primary" onclick="simulateEnglishAuction()">Simulate Auction</button>

        {% elif auction_type == 'dutch' %}
            <!-- Start Price Input for Dutch Auction -->
            <div class="row mb-3">
                <label for="start_price" class="col-sm-2 col-form-label">Start Price:</label>
                <div class="col-sm-10">
                    <input type="number" id="start_price" name="start_price" class="form-control" required>
                </div>
            </div>

            <!-- Price Decrement Input for Dutch Auction -->
            <div class="row mb-3">
                <label for="decrement" class="col-sm-2 col-form-label">Price Decrement:</label>
                <div class="col-sm-10">
                    <input type="number" id="decrement" name="decrement" class="form-control" required>
                </div>
            </div>

            <!-- Minimum Price Input for Dutch Auction -->
            <div class="row mb-3">
                <label for="min_price" class="col-sm-2 col-form-label">Minimum Price:</label>
                <div class="col-sm-10">
                    <input type="number" id="min_price" name="min_price" class="form-control" required>
                </div>
            </div>

            <!-- Simulate Auction Button for Dutch Auction -->
            <button type="button" class="btn btn-primary" onclick="simulateDutchAuction()">Simulate Auction</button>

        {% elif auction_type == 'vickrey' %}
            <!-- Simulate Auction Button for Vickrey Auction -->
            <button type="button" class="btn btn-primary" onclick="simulateVickreyAuction()">Simulate Auction</button>
        {% endif %}
    </form>

    <!-- Simulation Results Section -->
    <div id="simulation-result" class="mt-4" style="display:none;">
        <h2>Auction Result</h2>
        <p><strong>Winning Bidder:</strong> <span id="winning-bidder"></span></p>
        <p><strong>Winning Bid:</strong> $<span id="winning-bid"></span></p>

        <!-- List of All Bidders and Their Bids -->
        <h3>All Bidders:</h3>
        <ul id="all-bidders" class="list-group"></ul>

        <!-- Final Price and Number of Rounds -->
        <h3>Final Price:</h3>
        <p id="final-price"></p>

        <h3>Number of Rounds:</h3>
        <p id="rounds"></p>

        <!-- Educational Feedback Section -->
        <h3>Educational Feedback:</h3>
        <p id="feedback" class="alert alert-info"></p>

        <!-- Chart.js Chart -->
        <h3>Bids Overview</h3>
        <canvas id="bidsChart"></canvas> <!-- This is where the chart will be rendered -->

        <!-- Bid Progress Chart -->
        <h3>Bid Progress</h3>
        <canvas id="bidProgressChart"></canvas> <!-- This is where the line chart will be rendered -->

        <!-- Bidder Behavior Pie Chart -->
        <h3>Bidding Styles Distribution</h3>
        <canvas id="biddingStylesChart"></canvas> <!-- This is where the pie chart will be rendered -->

        <!-- Auction Outcome Summary -->
        <h3>Auction Outcome Summary</h3>
        <ul class="list-group">
            <li class="list-group-item">Highest Bid: <span id="highest-bid"></span></li>
            <li class="list-group-item">Lowest Bid: <span id="lowest-bid"></span></li>
            <li class="list-group-item">Average Bid: <span id="average-bid"></span></li>
            <li class="list-group-item">Winning Bid vs Reserve Price: <span id="winning-vs-reserve"></span></li>
        </ul>
    </div>
</div>

<!-- Include Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- JavaScript for Dynamic Form Updates and Auction Simulation -->
<script>
    let auctionChart; // Declare a variable to hold the bar chart instance
    let bidProgressChart; // Declare a variable to hold the line chart instance
    let biddingStylesChart; // Declare a variable to hold the pie chart instance
    let bidProgressData = []; // Array to store bid data for the line chart

    // Update Bidding Styles Based on Number of Bidders
    document.getElementById('num_bidders').addEventListener('input', updateBiddingStyles);

    function updateBiddingStyles() {
        const numBidders = document.getElementById('num_bidders').value;
        const biddingStylesDiv = document.getElementById('bidding-styles');
        biddingStylesDiv.innerHTML = '';

        for (let i = 1; i <= numBidders; i++) {
            biddingStylesDiv.innerHTML += `
                <div class="row mb-3">
                    <label for="bidder_${i}_style" class="col-sm-2 col-form-label">Bidder ${i} Style:</label>
                    <div class="col-sm-10">
                        <select id="bidder_${i}_style" name="bidder_${i}_style" class="form-select" required>
                            <option value="aggressive">Aggressive</option>
                            <option value="conservative">Conservative</option>
                            <option value="random">Random</option>
                        </select>
                    </div>
                </div>
            `;
        }
    }

    // Function to Simulate English Auction with Delay
    async function simulateEnglishAuction() {
        const numBidders = document.getElementById('num_bidders').value;
        const duration = document.getElementById('duration').value;
        const reservePrice = document.getElementById('reserve_price').value;
        const biddingStyles = [];

        for (let i = 1; i <= numBidders; i++) {
            const style = document.getElementById(`bidder_${i}_style`).value;
            biddingStyles.push(style);
        }

        const response = await fetch('/simulate-auction', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                auction_type: 'english',
                num_bidders: numBidders,
                duration: duration,
                reserve_price: reservePrice,
                bidding_styles: biddingStyles,
            }),
        });
        const data = await response.json();

        // Reset the bid progress data
        bidProgressData = [];

        // Delay loop for each round
        for (let i = 0; i < data.rounds; i++) {
            // Update the results and chart for each round
            displayResults(data);
            displayChart(data.bidders); // Ensure the Bids Overview chart is displayed
            updateBidProgressChart(data.bidders, i + 1); // Update the line chart with round data

            // Add delay (e.g., 1 second)
            await new Promise(resolve => setTimeout(resolve, 1000));
        }

        // Display the bidding styles pie chart
        displayBiddingStylesChart(biddingStyles);

        // Display the auction outcome summary
        displayAuctionSummary(data);
    }

    // Function to Simulate Dutch Auction with Delay
    async function simulateDutchAuction() {
        const numBidders = document.getElementById('num_bidders').value;
        const startPrice = document.getElementById('start_price').value;
        const decrement = document.getElementById('decrement').value;
        const minPrice = document.getElementById('min_price').value;

        const response = await fetch('/simulate-auction', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                auction_type: 'dutch',
                num_bidders: numBidders,
                start_price: startPrice,
                decrement: decrement,
                min_price: minPrice,
            }),
        });
        const data = await response.json();

        // Reset the bid progress data
        bidProgressData = [];

        // Delay loop for each round (here, rounds can be considered as each decrement step)
        for (let i = 0; i < data.rounds; i++) {
            // Update the results and chart for each decrement
            displayResults(data);
            displayChart(data.bidders); // Ensure the Bids Overview chart is displayed
            updateBidProgressChart(data.bidders, i + 1); // Update the line chart with round data

            // Add delay (e.g., 1 second)
            await new Promise(resolve => setTimeout(resolve, 1000));
        }

        // Display the bidding styles pie chart
        displayBiddingStylesChart([]); // Since Dutch Auction might not use styles, pass an empty array

        // Display the auction outcome summary
        displayAuctionSummary(data);
    }

    // Function to Simulate Vickrey Auction
    function simulateVickreyAuction() {
        const numBidders = document.getElementById('num_bidders').value;

        fetch('/simulate-auction', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                auction_type: 'vickrey',
                num_bidders: numBidders,
            }),
        })
        .then(response => response.json())
        .then(data => {
            displayResults(data);
            displayChart(data.bidders); // Display the chart after simulation
        });
    }

    // Function to Display Auction Results
    function displayResults(data) {
        document.getElementById('simulation-result').style.display = 'block';
        document.getElementById('winning-bidder').innerText = data.winning_bidder;
        document.getElementById('winning-bid').innerText = data.winning_bid;
        document.getElementById('final-price').innerText = data.final_price || 'N/A';
        document.getElementById('rounds').innerText = data.rounds || '1';
        document.getElementById('feedback').innerText = data.feedback;

        const allBiddersList = document.getElementById('all-bidders');
        allBiddersList.innerHTML = '';

        for (const bidder in data.bidders) {
            const li = document.createElement('li');
            li.classList.add('list-group-item');
            li.innerText = `${bidder}: $${data.bidders[bidder]}`;
            allBiddersList.appendChild(li);
        }
    }

    // Function to Display Bids Overview Chart
    function displayChart(bidders) {
        const ctx = document.getElementById('bidsChart').getContext('2d');
        const labels = Object.keys(bidders);
        const data = Object.values(bidders);

        // Destroy previous chart if it exists
        if (auctionChart) {
            auctionChart.destroy();
        }

        // Create a new chart
        auctionChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Bid Amount',
                    data: data,
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    // Function to Update Bid Progress Line Chart
    function updateBidProgressChart(bidders, round) {
        const highestBid = Math.max(...Object.values(bidders));
        bidProgressData.push({ x: round, y: highestBid });

        // Destroy previous chart if it exists
        if (bidProgressChart) {
            bidProgressChart.destroy();
        }

        const ctx = document.getElementById('bidProgressChart').getContext('2d');
        bidProgressChart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [{
                    label: 'Highest Bid per Round',
                    data: bidProgressData,
                    fill: false,
                    borderColor: 'rgba(255, 99, 132, 1)',
                    tension: 0.1
                }],
                labels: bidProgressData.map(d => d.x)
            },
            options: {
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Round'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Bid Amount'
                        }
                    }
                }
            }
        });
    }

    // Function to Display Bidding Styles Pie Chart
    function displayBiddingStylesChart(biddingStyles) {
        const styleCounts = biddingStyles.reduce((acc, style) => {
            acc[style] = (acc[style] || 0) + 1;
            return acc;
        }, {});

        const ctx = document.getElementById('biddingStylesChart').getContext('2d');

        // Destroy previous chart if it exists
        if (biddingStylesChart) {
            biddingStylesChart.destroy();
        }

        biddingStylesChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: Object.keys(styleCounts),
                datasets: [{
                    data: Object.values(styleCounts),
                    backgroundColor: ['rgba(75, 192, 192, 0.2)', 'rgba(255, 206, 86, 0.2)', 'rgba(153, 102, 255, 0.2)'],
                    borderColor: ['rgba(75, 192, 192, 1)', 'rgba(255, 206, 86, 1)', 'rgba(153, 102, 255, 1)'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true
            }
        });
    }

    // Function to Display Auction Outcome Summary
    function displayAuctionSummary(data) {
        const bids = Object.values(data.bidders);
        const highestBid = Math.max(...bids);
        const lowestBid = Math.min(...bids);
        const averageBid = (bids.reduce((a, b) => a + b, 0) / bids.length).toFixed(2);
        const winningVsReserve = data.reserve_price
            ? `$${data.winning_bid} (Reserve: $${data.reserve_price})`
            : `$${data.winning_bid} (No Reserve)`;

        document.getElementById('highest-bid').innerText = highestBid;
        document.getElementById('lowest-bid').innerText = lowestBid;
        document.getElementById('average-bid').innerText = averageBid;
        document.getElementById('winning-vs-reserve').innerText = winningVsReserve;
    }
</script>
{% endblock %}
